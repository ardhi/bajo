<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>class/bajo-core/build-config.js - Bajo Framework</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://bajo.app" target="_blank" class="menu-item" >Project Website</a></h2><h2><a href="https://github.com/ardhi/bajo" target="_blank" class="menu-item" >Github</a></h2><h3 class="collapsed_header">Classes</h3><ul class="collapse_top"><li><a href="App.html">App</a><ul class='methods'><li data-type='method' style='display: none;'><a href="App.html#addPlugin">addPlugin</a></li><li data-type='method' style='display: none;'><a href="App.html#boot">boot</a></li><li data-type='method' style='display: none;'><a href="App.html#dump">dump</a></li></ul></li><li><a href="BajoCore.html">BajoCore</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoCore.html#breakNsPath">breakNsPath</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#buildCollections">buildCollections</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#callHandler">callHandler</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#eachPlugins">eachPlugins</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#findDeep">findDeep</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#format">format</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#formatByType">formatByType</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#freeze">freeze</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#generateId">generateId</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getGlobalModuleDir">getGlobalModuleDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getMethod">getMethod</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getModuleDir">getModuleDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPlugin">getPlugin</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPluginDataDir">getPluginDataDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPluginFile">getPluginFile</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getUnitFormat">getUnitFormat</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#importModule">importModule</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#importPkg">importPkg</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isEmptyDir">isEmptyDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isLogInRange">isLogInRange</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isValidApp">isValidApp</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isValidPlugin">isValidPlugin</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#numUnit">numUnit</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseDt">parseDt</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseDur">parseDur</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseObject">parseObject</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#readConfig">readConfig</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#readJson">readJson</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#resolvePath">resolvePath</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#runHook">runHook</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#saveAsDownload">saveAsDownload</a></li></ul></li><li><a href="BajoError.html">BajoError</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoError.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="BajoError.html#formatErrorDetails">formatErrorDetails</a></li><li data-type='method' style='display: none;'><a href="BajoError.html#write">write</a></li></ul></li><li><a href="BajoPlugin.html">BajoPlugin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoPlugin.html#exit">exit</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#init">init</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#start">start</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#stop">stop</a></li></ul></li><li><a href="Log.html">Log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Log.html#child">child</a></li><li data-type='method' style='display: none;'><a href="Log.html#debug">debug</a></li><li data-type='method' style='display: none;'><a href="Log.html#error">error</a></li><li data-type='method' style='display: none;'><a href="Log.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Log.html#formatMsg">formatMsg</a></li><li data-type='method' style='display: none;'><a href="Log.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Log.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Log.html#isExtLogger">isExtLogger</a></li><li data-type='method' style='display: none;'><a href="Log.html#isIgnored">isIgnored</a></li><li data-type='method' style='display: none;'><a href="Log.html#trace">trace</a></li><li data-type='method' style='display: none;'><a href="Log.html#warn">warn</a></li><li data-type='method' style='display: none;'><a href="Log.html#write">write</a></li></ul></li><li><a href="Plugin.html">Plugin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Plugin.html#error">error</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#initLog">initLog</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#initPrint">initPrint</a></li></ul></li><li><a href="Print.html">Print</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Print.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="Print.html#fail">fail</a></li><li data-type='method' style='display: none;'><a href="Print.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Print.html#getElapsed">getElapsed</a></li><li data-type='method' style='display: none;'><a href="Print.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Print.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Print.html#render">render</a></li><li data-type='method' style='display: none;'><a href="Print.html#setOpts">setOpts</a></li><li data-type='method' style='display: none;'><a href="Print.html#setText">setText</a></li><li data-type='method' style='display: none;'><a href="Print.html#spinner">spinner</a></li><li data-type='method' style='display: none;'><a href="Print.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Print.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Print.html#succeed">succeed</a></li><li data-type='method' style='display: none;'><a href="Print.html#warn">warn</a></li><li data-type='method' style='display: none;'><a href="Print.html#write">write</a></li></ul></li></ul><h3 class="collapsed_header">Modules</h3><ul class="collapse_top"><li><a href="module-class_bajo-core_build-config.html">class/bajo-core/build-config</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-class_bajo-core_build-config.html#.buildBaseConfig">buildBaseConfig</a></li><li data-type='method' style='display: none;'><a href="module-class_bajo-core_build-config.html#.buildExtConfig">buildExtConfig</a></li></ul></li><li><a href="module-class_bajo-core_build-plugins.html">class/bajo-core/build-plugins</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-class_bajo-core_build-plugins.html#~buildPlugins">buildPlugins</a></li></ul></li><li><a href="module-lib_create-method.html">lib/create-method</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib_create-method.html#~createMethod">createMethod</a></li></ul></li><li><a href="module-lib_formats.html">lib/formats</a></li><li><a href="module-lib_log-levels.html">lib/log-levels</a></li><li><a href="module-lib_shim.html">lib/shim</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib_shim.html#~shim">shim</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
    
</nav>

<div id="main">
    
    <h1 class="page-title">class/bajo-core/build-config.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import readAllConfigs from '../../lib/read-all-configs.js'
import currentLoc from '../../lib/current-loc.js'
import omitDeep from 'omit-deep'
import os from 'os'
import fs from 'fs-extra'

import lodash from 'lodash'
const { map, pick, values, keys, set, get } = lodash

const omitted = ['spawn', 'cwd', 'name', 'alias', 'applet', 'a', 'plugins']

const defConfig = {
  log: {
    dateFormat: 'YYYY-MM-DDTHH:MM:ss.SSS[Z]',
    plain: false,
    applet: false,
    traceHook: false
  },
  lang: Intl.DateTimeFormat().resolvedOptions().lang ?? 'en-US',
  intl: {
    supported: ['en-US', 'id'],
    fallback: 'en-US',
    lookupOrder: [],
    format: {
      emptyValue: '',
      datetime: { dateStyle: 'medium', timeStyle: 'short' },
      date: { dateStyle: 'medium' },
      time: { timeStyle: 'short' },
      float: { maximumFractionDigits: 2 },
      double: { maximumFractionDigits: 5 },
      smallint: {},
      integer: {}
    },
    unitSys: {
      'en-US': 'imperial',
      id: 'metric'
    }
  },
  exitHandler: true
}

/**
 * @module
 */

/**
 * Building bajo core base config. Mostly dealing with directory setups:
 * - determine base directory
 * - check whether data directory is valid
 * - ensure data config directory is there
 */
export async function buildBaseConfig () {
  const { defaultsDeep } = this.lib.aneka
  this.applet = this.app.argv._.applet
  this.config = defaultsDeep({}, this.app.env._, this.app.argv._)
  this.alias = this.name
  set(this, 'dir.base', this.app.dir)
  const path = currentLoc(import.meta).dir + '/../../..'
  set(this, 'dir.pkg', this.resolvePath(path))
  if (!get(this, 'dir.data')) set(this, 'dir.data', `${this.dir.base}/data`)
  this.dir.data = this.resolvePath(this.dir.data)
  if (!fs.existsSync(this.dir.data)) {
    console.log('Data directory (%s) doesn\'t exist yet', this.dir.data)
    process.exit(1)
  }
  fs.ensureDirSync(`${this.dir.data}/config`)
  if (!this.dir.tmp) {
    this.dir.tmp = `${this.resolvePath(os.tmpdir())}/${this.name}`
    fs.ensureDirSync(this.dir.tmp)
  }
  this.app.addPlugin(this)
}

/**
 * Bajo core extra config:
 * - reading core config file
 * - merge config with arguments &amp; environments values
 * - Set environment (```dev``` or ```prod```)
 */
export async function buildExtConfig () {
  // config merging
  const { defaultsDeep } = this.lib.aneka
  let resp = await readAllConfigs.call(this.app, `${this.dir.data}/config/${this.name}`)
  resp = omitDeep(pick(resp, ['log', 'exitHandler', 'env']), omitted)
  this.config = defaultsDeep({}, this.config, resp, defConfig)
  this.config.env = (this.config.env ?? 'dev').toLowerCase()
  if (values(this.envs).includes(this.config.env)) this.config.env = this.lib.aneka.getKeyByValue(this.envs, this.config.env)
  if (!keys(this.envs).includes(this.config.env)) throw new Error(`Unknown environment '${this.config.env}'. Supported: ${this.join(keys(this.envs))}`)
  process.env.NODE_ENV = this.envs[this.config.env]
  if (!this.config.log.level) this.config.log.level = this.config.env === 'dev' ? 'debug' : 'info'
  if (this.config.silent) this.config.log.level = 'silent'
  if (this.applet) {
    if (!this.pluginPkgs.includes('bajo-cli')) throw new Error('Applet needs to have \'bajo-cli\' loaded first')
    if (!this.config.log.applet) this.config.log.level = 'silent'
    this.config.exitHandler = false
  }
  const exts = map(this.configHandlers, 'ext')
  this.initPrint()
  this.initLog()
  this.log.debug('configHandlers%s', this.join(exts))
  this.config = this.parseObject(this.config, { parseValue: true })
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sat Aug 23 2025 09:45:48 GMT+0700 (Western Indonesia Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
