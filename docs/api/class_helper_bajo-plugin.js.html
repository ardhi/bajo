<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>class/helper/bajo-plugin.js - Bajo Framework</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://bajo.app" target="_blank" class="menu-item" >Project Website</a></h2><h2><a href="https://github.com/ardhi/bajo" target="_blank" class="menu-item" >Github</a></h2><h3 class="collapsed_header">Classes</h3><ul class="collapse_top"><li><a href="App.html">App</a><ul class='methods'><li data-type='method' style='display: none;'><a href="App.html#addPlugin">addPlugin</a></li><li data-type='method' style='display: none;'><a href="App.html#boot">boot</a></li><li data-type='method' style='display: none;'><a href="App.html#dump">dump</a></li></ul></li><li><a href="BajoCore.html">BajoCore</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoCore.html#breakNsPath">breakNsPath</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#buildCollections">buildCollections</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#callHandler">callHandler</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#eachPlugins">eachPlugins</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#findDeep">findDeep</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#format">format</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#formatByType">formatByType</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#freeze">freeze</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#generateId">generateId</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getGlobalModuleDir">getGlobalModuleDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getMethod">getMethod</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getModuleDir">getModuleDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPlugin">getPlugin</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPluginDataDir">getPluginDataDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getPluginFile">getPluginFile</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#getUnitFormat">getUnitFormat</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#importModule">importModule</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#importPkg">importPkg</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isEmptyDir">isEmptyDir</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isLogInRange">isLogInRange</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isValidApp">isValidApp</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#isValidPlugin">isValidPlugin</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#numUnit">numUnit</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseDt">parseDt</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseDur">parseDur</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#parseObject">parseObject</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#readConfig">readConfig</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#readJson">readJson</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#resolvePath">resolvePath</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#runHook">runHook</a></li><li data-type='method' style='display: none;'><a href="BajoCore.html#saveAsDownload">saveAsDownload</a></li></ul></li><li><a href="BajoError.html">BajoError</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoError.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="BajoError.html#formatErrorDetails">formatErrorDetails</a></li><li data-type='method' style='display: none;'><a href="BajoError.html#write">write</a></li></ul></li><li><a href="BajoPlugin.html">BajoPlugin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BajoPlugin.html#exit">exit</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#init">init</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#start">start</a></li><li data-type='method' style='display: none;'><a href="BajoPlugin.html#stop">stop</a></li></ul></li><li><a href="Log.html">Log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Log.html#child">child</a></li><li data-type='method' style='display: none;'><a href="Log.html#debug">debug</a></li><li data-type='method' style='display: none;'><a href="Log.html#error">error</a></li><li data-type='method' style='display: none;'><a href="Log.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Log.html#formatMsg">formatMsg</a></li><li data-type='method' style='display: none;'><a href="Log.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Log.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Log.html#isExtLogger">isExtLogger</a></li><li data-type='method' style='display: none;'><a href="Log.html#isIgnored">isIgnored</a></li><li data-type='method' style='display: none;'><a href="Log.html#trace">trace</a></li><li data-type='method' style='display: none;'><a href="Log.html#warn">warn</a></li><li data-type='method' style='display: none;'><a href="Log.html#write">write</a></li></ul></li><li><a href="Plugin.html">Plugin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Plugin.html#error">error</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#initLog">initLog</a></li><li data-type='method' style='display: none;'><a href="Plugin.html#initPrint">initPrint</a></li></ul></li><li><a href="Print.html">Print</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Print.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="Print.html#fail">fail</a></li><li data-type='method' style='display: none;'><a href="Print.html#fatal">fatal</a></li><li data-type='method' style='display: none;'><a href="Print.html#getElapsed">getElapsed</a></li><li data-type='method' style='display: none;'><a href="Print.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Print.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Print.html#render">render</a></li><li data-type='method' style='display: none;'><a href="Print.html#setOpts">setOpts</a></li><li data-type='method' style='display: none;'><a href="Print.html#setText">setText</a></li><li data-type='method' style='display: none;'><a href="Print.html#spinner">spinner</a></li><li data-type='method' style='display: none;'><a href="Print.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Print.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Print.html#succeed">succeed</a></li><li data-type='method' style='display: none;'><a href="Print.html#warn">warn</a></li><li data-type='method' style='display: none;'><a href="Print.html#write">write</a></li></ul></li></ul><h3 class="collapsed_header">Modules</h3><ul class="collapse_top"><li><a href="module-class_helper_bajo-core.html">class/helper/bajo-core</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-core.html#.bootPlugins">bootPlugins</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-core.html#.buildBaseConfig">buildBaseConfig</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-core.html#.buildExtConfig">buildExtConfig</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-core.html#.buildPlugins">buildPlugins</a></li></ul></li><li><a href="module-class_helper_bajo-plugin.html">class/helper/bajo-plugin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.attachMethods">attachMethods</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.buildConfigs">buildConfigs</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.checkDependencies">checkDependencies</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.checkNameAliases">checkNameAliases</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.collectHooks">collectHooks</a></li><li data-type='method' style='display: none;'><a href="module-class_helper_bajo-plugin.html#.run">run</a></li></ul></li><li><a href="module-lib_create-method.html">lib/create-method</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib_create-method.html#~createMethod">createMethod</a></li></ul></li><li><a href="module-lib_formats.html">lib/formats</a></li><li><a href="module-lib_log-levels.html">lib/log-levels</a></li><li><a href="module-lib_shim.html">lib/shim</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib_shim.html#~shim">shim</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
    
</nav>

<div id="main">
    
    <h1 class="page-title">class/helper/bajo-plugin.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import createMethod from '../../lib/create-method.js'
import semver from 'semver'
import lodash from 'lodash'

const {
  merge,
  forOwn,
  groupBy,
  find,
  reduce,
  map,
  trim,
  keys,
  intersection,
  each,
  camelCase,
  get
} = lodash

/**
 * @module
 */

/**
 * Scan plugins ```method``` directories, and turn + attach its found files as methods dynamically.
 *
 * @async
 */
export async function attachMethods () {
  const { eachPlugins } = this.bajo
  const me = this // the app
  me.bajo.log.debug('attachMethods')
  await eachPlugins(async function () {
    const { name: ns, pkgName } = this
    const dir = ns === me.bajo.mainNs ? (`${me.bajo.dir.base}/${me.bajo.mainNs}`) : me.bajo.getModuleDir(pkgName)
    const num = await createMethod.call(me[ns], `${dir}/method`, pkgName)
    me.bajo.log.trace('- %s (%d)', ns, num)
  })
}

/**
 * Build configurations
 *
 * @async
 */
export async function buildConfigs () {
  this.bajo.log.debug('readConfigs')
  for (const pkg of this.bajo.pluginPkgs) {
    const plugin = this[camelCase(pkg)]
    await plugin.loadConfig()
    plugin.initPrint()
    plugin.initLog()
  }
}

/**
 * Ensure for names and aliases to be unique and no clashes with other plugins
 *
 * @async
 */
export async function checkNameAliases () {
  const { eachPlugins } = this.bajo
  this.bajo.log.debug('checkAliasNameClash')
  const refs = []
  await eachPlugins(async function () {
    const { name: ns, pkgName, alias } = this
    let item = find(refs, { ns })
    if (item) throw this.error('pluginNameClash%s%s%s%s', ns, pkgName, item.ns, item.pkgName, { code: 'BAJO_NAME_CLASH' })
    item = find(refs, { alias })
    if (item) throw this.error('pluginNameClash%s%s%s%s', alias, pkgName, item.alias, item.pkgName, { code: 'BAJO_ALIAS_CLASH' })
    refs.push({ ns, alias, pkgName })
  })
}

/**
 * Ensure dependencies are met
 *
 * @async
 */
export async function checkDependencies () {
  async function runner () {
    const { name: ns, pkgName } = this
    const { join } = this.app.bajo
    this.app.bajo.log.trace('- %s', ns)
    const odep = reduce(this.dependencies, (o, k) => {
      const item = map(k.split('@'), m => trim(m))
      if (k[0] === '@') o['@' + item[1]] = item[2]
      else o[item[0]] = item[1]
      return o
    }, {})
    const deps = keys(odep)
    if (deps.length > 0) {
      if (intersection(this.app.bajo.pluginPkgs, deps).length !== deps.length) {
        throw this.error('dependencyUnfulfilled%s%s', pkgName, join(deps), { code: 'BAJO_DEPENDENCY' })
      }
      each(deps, d => {
        if (!odep[d]) return
        const ver = get(this.app[camelCase(d)], 'config.pkg.version')
        if (!ver) return
        if (!semver.satisfies(ver, odep[d])) {
          throw this.error('semverCheckFailed%s%s', pkgName, `${d}@${odep[d]}`, { code: 'BAJO_DEPENDENCY_SEMVER' })
        }
      })
    }
  }

  const { eachPlugins } = this.bajo
  this.bajo.log.debug('checkDeps')
  await eachPlugins(async function () {
    await runner.call(this)
  })
}

/**
 * Collect and build hooks and push them to the bajo's hook system
 *
 * @async
 */
export async function collectHooks () {
  const { eachPlugins, runHook, isLogInRange, importModule, breakNsPathFromFile } = this.bajo
  const me = this
  me.bajo.hooks = this.bajo.hooks ?? []
  me.bajo.log.debug('collectHooks')
  // collects
  await eachPlugins(async function ({ dir, file }) {
    const { name: ns } = this
    const { fullNs, path } = breakNsPathFromFile({ file, dir, baseNs: ns, suffix: '/hook/' })
    const mod = await importModule(file, { asHandler: true })
    if (!mod) return undefined
    merge(mod, { ns: fullNs, path, src: ns })
    me.bajo.hooks.push(mod)
  }, { glob: 'hook/**/*.js', prefix: me.bajo.name })
  // for log trace purpose only
  if (!isLogInRange('trace')) return
  const items = groupBy(me.bajo.hooks, 'ns')
  forOwn(items, (v, k) => {
    const hooks = groupBy(v, 'path')
    forOwn(hooks, (v1, k1) => {
      me.bajo.log.trace('- %s:%s (%d)', k, k1, v1.length)
    })
  })
  // run handler
  await runHook('bajo:afterCollectHooks')
}

/**
 * Finally, run all plugins
 *
 * @async
 */
export async function run () {
  const me = this
  const { runHook, eachPlugins, join } = me.bajo
  const { freeze } = me.bajo
  const methods = ['init']
  if (!me.bajo.applet) methods.push('start')
  for (const method of methods) {
    await runHook(`bajo:${camelCase(`before ${method} all plugins`)}`)
    await eachPlugins(async function () {
      const { name: ns } = this
      if (method === 'start') freeze(me[ns].config)
      await runHook(`${ns}:${camelCase(`before ${method}`)}`)
      await me[ns][method]()
      await runHook(`${ns}:${camelCase(`after ${method}`)}`)
    })
    await runHook(`bajo:${camelCase(`after ${method} all plugins`)}`)
  }
  me.bajo.log.debug('loadedPlugins%s', join(map(me.bajo.pluginPkgs, b => camelCase(b))))
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sat Aug 23 2025 10:40:51 GMT+0700 (Western Indonesia Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
